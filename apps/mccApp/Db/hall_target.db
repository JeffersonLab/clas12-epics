#
# MCC needs a PV for human consumption to check against the maximum
# beam current limitations in operating procedures documentation.
# For that, we have these:
#
# HLB:TARGET:STAT has been used by MCC in the past
# HALL_B_TARGET is owned by MCC and what they wanted to start using in 2022
#
# Meanwhile, Hall B needs something appropriate for RCDB and sometimes
# (much) shorter than the MCC name above.  That's what this is for:
#
# clas12:target:type
#
# They have a 1:1 mapping below, either via aliasing or linked mbbis to
# support 2 naming schemes.
#

# Flag locations
# 0 Empty
# 1 Cu-Sn
# 2 Carbon
#
# species
# 0 H2
# 1 D2
# 2 4He
# 3 3He
#
# production
# 0 Empty
# 1 Full
# 2 Solid
# 3 Full+Solid
# 4 Not Ready
#

record(calc,"HLB:TARGET:CALC:rgd") {
    field(PINI,1)
    field(INPA, "TGT:BTARG:production CPP")
    field(INPB, "TGT:BTARG:species CPP")
    field(INPC, "TGT:BTARG:Flag_locations CPP")
    field(CALC, "A=1?B+1:(A=2?C+5:(A=0?0:10))")
}

record(calcout,"HLB:TARGET:CALC")
{
  field(PINI,1)
  field(INPA,"moller_target_empty CPP")
  field(INPB,"harp_2H01.RBV CPP")
  field(INPC,"harp_tagger.RBV CPP")
  field(INPD,"harp_2c21.RBV CPP")
  field(INPE,"HLB:TARGET:CALC:rgd CPP")
  field(CALC,"A#1?9:((B>0.1||C>0.1||D>0.1)?8:E)")
  field(OOPT,"Every Time")
  field(DOPT,"Use CALC")
  field(OUT,"HLB:TARGET:STAT PP")
  info(autosaveFields_pass0,"VAL")
}

record(stringout,"HLB:TARGET:STRINGOUT")
{
  field(SCAN,"1 second")
  field(OMSL,"closed_loop")
  field(DOL,"HLB:TARGET:STAT")
  field(OUT,"HALL_B_TARGET PP")
}

record(mbbi,"HLB:TARGET:STAT")
{
    alias("clas12:target:type")
    #alias("hps:target:type")
#
####################
# RGD:
    field(ZRVL,0)
    field(ONVL,1)
    field(TWVL,2)
    field(THVL,3)
    field(FRVL,4)
    field(FVVL,5)
    field(SXVL,6)
    field(SVVL,7)
    field(EIVL,8)
    field(NIVL,9)
    field(TEVL,10)
    field(TESV,"MAJOR")
    field(ZRST, "Empty")
    field(ONST, "LH2")
    field(TWST, "LD2")
    field(THST, "L4He")
    field(FRST, "L3He")
    field(FVST, "Empty")
    field(SXST, "CuSn")
    field(SVST, "CxC")
    field(EIST, "Harp Wire")
    field(NIST, "Moller")
    field(TEST, "Unknown")
####################
# RGC:
#     field(ZRST, "Empty")
#     field(ONST, "NH3")
#     field(TWST, "ND3")
#     field(THST, "CH2")
#     field(FRST, "CD2")
#     field(FVST, "C")
#
####################
# OLD:
#  field(ZRST,"Moller")
#  field(ONST,"Harp 2H01")
#
####################
# RG-M Mess:
#    field(VAL,"9")
#    field(PINI,"YES")
#    field(ZRST,"Liquid Hydrogen Target")
#    field(ONST,"Liquid Deuterium Target")
#    field(TWST,"Liquid 4He target")
#    field(THST,"Liquid Argon")
#    field(FRST,"Carbon target 2 mm (4x)")
#    field(FVST,"Carbon target 2 mm")
#    field(SXST,"300 um Sn")
#    field(SVST,"40Ca")
#    field(EIST,"48Ca")
#    field(NIST,"Empty cell")
#
####################
# BONuS Target:
#  field(TWST,"H2")
#  field(THST,"D2")
#  field(FRST,"4He")
#  field(FVST,"N2")
#
####################
# Saclay Target:
#  field(TWST,"Empty")
#  field(THST,"Partial LH2")
#  field(FRST,"Partial LD2")
#  field(FVST,"Partial L3H3")
#  field(SXST,"Partial L4He")
#  field(SVST,"LH2")
#  field(EIST,"LD2")
#  field(NIST,"L3He")
#  field(TEST,"L4He")
#
}

