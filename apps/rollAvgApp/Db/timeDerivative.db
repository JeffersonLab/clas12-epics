#
# Calculate a time-derivative, based on periodically sampling a value,
# as the difference between the current and previous values divided by
# the sampling period.
#
# Sampling period must be an EPICS scan period (1/2/5/10).
#
# N. Baltzell
#
# $(P)          = the PV of which to calculate the time-derivative,
# $(DT)         = the sampling period
# $(P)$(R=):dxdt = the resulting time-derivate
#

# The PV of which to calculate the time-derivative (only for testing):
#record(ai,"$(P)") {
#    field(VAL,0)
#    field(PINI,1)
#}

record(ai,"$(P)$(R=):prev") {
    field(VAL,0)
    field(PINI,1)
}
record(calcout,"$(P)$(R=):prevC") {
    field(SCAN,"$(DT) second")
    field(INPA,"$(P)")
    field(CALC,A)
    field(OOPT,"Every Time")
    field(DOPT,"Use CALC")
    field(OUT,"$(P)$(R=):prev PP")
    field(ODLY,"0")
    field(FLNK,"$(P)$(R=):delay.PROC PP")
}
record(seq,"$(P)$(R=):delay") {
    field(DOL1,"$(P)$(R=):dxdt PP")
    field(DO1,"1")
    field(DLY1,"$(DT)")
}
record(calc,"$(P)$(R=):dxdt") {
    field(INPA,"$(P)$(R=)")
    field(INPB,"$(P)$(R=):prev")
    field(INPC,"$(DT)")
    field(CALC,"(A-B)/C")
    field(PREC,"5")
    field(EGU,"dx/$(DT)s")
}

